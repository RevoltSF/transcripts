name: Purge Old Files
on:
  schedule:
    - cron: "0 0 1,15 * *"
  workflow_dispatch:
jobs:
  purge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Delete old files
        run: |
          set +e
          purge_folder() {
            FOLDER="$1"
            DAYS="$2"
            CUTOFF=$(date -d "${DAYS} days ago" +%s)
            DELETED=0
            SKIPPED=0
            if [ ! -d "$FOLDER" ] || [ -z "$(ls $FOLDER/*.html 2>/dev/null)" ]; then
              echo "No files found in $FOLDER, skipping."
              return
            fi
            for file in $FOLDER/*.html; do
              [ -f "$file" ] || continue
              COMMIT_DATE=$(git log -1 --format="%ct" -- "$file")
              if [ -z "$COMMIT_DATE" ]; then
                echo "Skipping $file (no commit date found)"
                SKIPPED=$((SKIPPED + 1))
                continue
              fi
              if [ "$COMMIT_DATE" -lt "$CUTOFF" ]; then
                echo "Deleting $file (committed $(date -d @$COMMIT_DATE))"
                git rm "$file"
                DELETED=$((DELETED + 1))
              else
                SKIPPED=$((SKIPPED + 1))
              fi
            done
            echo "[$FOLDER] Deleted: $DELETED | Skipped: $SKIPPED"
          }
          purge_folder "mod-logs" 90
          purge_folder "catering-logs" 90
          if git diff --cached --quiet; then
            echo "Nothing to purge."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Purge old files"
            git push
          fi
